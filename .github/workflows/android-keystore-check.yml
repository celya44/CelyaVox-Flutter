# yamllint disable rule:line-length rule:truthy
---
name: Android Keystore Check

on:
  workflow_dispatch:
    inputs:
      target:
        description: Build target to validate signing
        required: true
        default: appbundle
        type: choice
        options:
          - appbundle
          - apk

permissions:
  contents: read

jobs:
  keystore-test:
    runs-on: ubuntu-latest
    env:
      ANDROID_KEYSTORE_PASSWORD: ${{ secrets.ANDROID_KEYSTORE_PASSWORD }}
      ANDROID_KEY_ALIAS: ${{ secrets.ANDROID_KEY_ALIAS }}
      ANDROID_KEY_PASSWORD: ${{ secrets.ANDROID_KEY_PASSWORD }}
      ANDROID_KEYSTORE_BASE64: ${{ secrets.ANDROID_KEYSTORE_BASE64 }}
      ANDROID_KEYSTORE_PATH: android/app/upload-keystore.jks
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Ensure unix line endings for gradlew
        run: |
            if command -v dos2unix &> /dev/null; then
              dos2unix android/gradlew
            else
              perl -pi -e 's/\r\n|\n|\r/\n/g' android/gradlew
            fi

      - name: Set up Java 17
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: '17'

      - name: Install Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: stable
          cache: true

      - name: Resolve Flutter version
        id: flutter-version
        run: echo "version=$(flutter --version --machine | jq -r '.flutterVersion')" >> "$GITHUB_OUTPUT"

      - name: Cache Flutter SDK
        uses: actions/cache@v4
        with:
          path: |
            ~/.flutter
          key: flutter-sdk-${{ runner.os }}-${{ steps.flutter-version.outputs.version }}
          restore-keys: |
            flutter-sdk-${{ runner.os }}-

      - name: Flutter doctor
        run: flutter doctor -v

      - name: Cache pub
        uses: actions/cache@v4
        with:
          path: ~/.pub-cache
          key: pub-${{ runner.os }}-${{ steps.flutter-version.outputs.version }}-${{ hashFiles('pubspec.lock') }}
          restore-keys: |
            pub-${{ runner.os }}-${{ steps.flutter-version.outputs.version }}-
            pub-${{ runner.os }}-

      - name: Install Android SDK + NDK
        uses: android-actions/setup-android@v3
        with:
          ndk: r26b
          api-level: 35
          cmake: '3.22.1'

      - name: Ensure Gradle wrapper executable
        run: chmod +x android/gradlew

      - name: Validate keystore secrets
        run: |
          missing=0
          for var in ANDROID_KEYSTORE_BASE64 ANDROID_KEYSTORE_PASSWORD ANDROID_KEY_ALIAS ANDROID_KEY_PASSWORD; do
            if [ -z "${!var}" ]; then
              echo "::error title=Missing secret::$var is empty"
              missing=1
            else
              echo "$var is set"
            fi
          done
          if [ "$missing" = "1" ]; then
            exit 1
          fi

      - name: Diagnostic (context + secret lengths)
        run: |
          echo "event=${GITHUB_EVENT_NAME}"
          echo "actor=${GITHUB_ACTOR}"
          echo "repository=${GITHUB_REPOSITORY}"
          if [ "${{ github.event.pull_request.head.repo.full_name || '' }}" != "" ]; then
            echo "pr_head_repo=${{ github.event.pull_request.head.repo.full_name }}"
            echo "pr_head_repo_owner=${{ github.event.pull_request.head.repo.owner.login }}"
          fi
          for var in ANDROID_KEYSTORE_BASE64 ANDROID_KEYSTORE_PASSWORD ANDROID_KEY_ALIAS ANDROID_KEY_PASSWORD; do
            val="${!var}"
            if [ -z "$val" ]; then
              echo "$var length=0"
            else
              echo "$var length=${#val}"
            fi
          done
          echo "Validating base64 decodeâ€¦"
          echo "$ANDROID_KEYSTORE_BASE64" | base64 --decode >/tmp/ks.bin || { echo "::error title=Base64 decode failed::Check ANDROID_KEYSTORE_BASE64"; exit 1; }
          rm -f /tmp/ks.bin

      - name: Decode Android keystore
        run: echo "$ANDROID_KEYSTORE_BASE64" | base64 --decode > "$ANDROID_KEYSTORE_PATH"

      - name: Inspect keystore alias
        run: |
          keytool -list -v \
            -keystore "$ANDROID_KEYSTORE_PATH" \
            -storepass "$ANDROID_KEYSTORE_PASSWORD" \
            -alias "$ANDROID_KEY_ALIAS" \
            -keypass "$ANDROID_KEY_PASSWORD" \
            | sed -n '1,40p'

      - name: Flutter pub get
        run: flutter pub get

      - name: Gradle signing report
        working-directory: android
        run: |
          set -x
          ls -l "$ANDROID_KEYSTORE_PATH" || true
          bash -x ./gradlew --no-daemon signingReport

      - name: Build target
        run: |
          if [ "${{ github.event.inputs.target }}" = "apk" ]; then
            flutter build apk --release --android-skip-build-dependency-validation
          else
            flutter build appbundle --release --android-skip-build-dependency-validation
          fi

      - name: List build outputs
        run: |
          ls -R build/app/outputs || true
          ls -R android/app/build/outputs || true
          find build -maxdepth 6 -name "*.apk" -print || true
          find build -maxdepth 6 -name "*.aab" -print || true
          find android -maxdepth 6 -name "*.apk" -print || true
          find android -maxdepth 6 -name "*.aab" -print || true

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: android-keystore-check-${{ github.event.inputs.target }}
          if-no-files-found: warn
          path: |
            build/app/outputs/flutter-apk/*.apk
            android/app/build/outputs/apk/**/*.apk
            build/app/outputs/bundle/release/*.aab
            android/app/build/outputs/bundle/**/*.aab
