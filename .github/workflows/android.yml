name: Android Build

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Java 17
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: '17'

      - name: Install Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: stable
          cache: true

      - name: Resolve Flutter version
        id: flutter-version
        run: echo "version=$(flutter --version --machine | jq -r '.flutterVersion')" >> "$GITHUB_OUTPUT"

      - name: Cache Flutter SDK
        uses: actions/cache@v4
        with:
          path: |
            ~/.flutter
            ~/.cache/flutter
          key: flutter-sdk-${{ runner.os }}-${{ steps.flutter-version.outputs.version }}
          restore-keys: |
            flutter-sdk-${{ runner.os }}-

      - name: Flutter doctor
        run: flutter doctor -v
        working-directory: ./

      - name: Cache pub
        uses: actions/cache@v4
        with:
          path: ~/.pub-cache
          key: pub-${{ runner.os }}-${{ steps.flutter-version.outputs.version }}-${{ hashFiles('pubspec.lock') }}
          restore-keys: |
            pub-${{ runner.os }}-${{ steps.flutter-version.outputs.version }}-
            pub-${{ runner.os }}-

      - name: Install Android SDK + NDK
        uses: android-actions/setup-android@v3
        with:
          ndk: r26b
          api-level: 35
          cmake: '3.22.1'

      - name: Cache Gradle
        uses: actions/cache@v4
        with:
          path: |
            ~/.gradle/caches
            ~/.gradle/wrapper
          key: gradle-${{ runner.os }}-${{ hashFiles('android/app/build.gradle', 'android/build.gradle') }}
          restore-keys: |
            gradle-${{ runner.os }}-

      - name: Decode Android keystore
        env:
          ANDROID_KEYSTORE_BASE64: ${{ secrets.ANDROID_KEYSTORE_BASE64 || '' }}
        if: ${{ env.ANDROID_KEYSTORE_BASE64 != '' }}
        run: |
          echo "$ANDROID_KEYSTORE_BASE64" | base64 --decode > android/app/upload-keystore.jks

      - name: Flutter pub get
        run: flutter pub get
        working-directory: ./

      - name: Build APK (debug)
        run: flutter build apk --debug --android-skip-build-dependency-validation
        working-directory: ./

      - name: List build outputs (APK)
        run: |
          ls -R build/app/outputs || true
          ls -R android/app/build/outputs || true
        working-directory: ./

      - name: Build App Bundle (release)
        env:
          ANDROID_KEYSTORE_PASSWORD: ${{ secrets.ANDROID_KEYSTORE_PASSWORD }}
          ANDROID_KEY_ALIAS: ${{ secrets.ANDROID_KEY_ALIAS }}
          ANDROID_KEY_PASSWORD: ${{ secrets.ANDROID_KEY_PASSWORD }}
        run: |
          echo "signingConfigs {
              release {
                  storeFile file('upload-keystore.jks')
                  storePassword System.getenv('ANDROID_KEYSTORE_PASSWORD')
                  keyAlias System.getenv('ANDROID_KEY_ALIAS')
                  keyPassword System.getenv('ANDROID_KEY_PASSWORD')
              }
          }" > android/app/signing.generated.gradle
          echo "apply from: 'signing.generated.gradle'" >> android/app/build.gradle
          flutter build appbundle --release --android-skip-build-dependency-validation
        working-directory: ./

      - name: List build outputs (AAB)
        run: |
          ls -R build/app/outputs || true
          ls -R android/app/build/outputs || true
        working-directory: ./

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: android-builds
          path: |
            build/app/outputs/flutter-apk/*.apk
            android/app/build/outputs/apk/**/*.apk
            build/app/outputs/bundle/release/*.aab
            android/app/build/outputs/bundle/**/*.aab
